---
import { TICKETING_BASE_URL } from '../../config/cta'
import { EVENT_DATA } from '../../config'
import { EXPERIMENTS, labelFor } from '../../config/experiments'

const isTicketingOpen = EVENT_DATA.event.ticketingOpen
const CTA_LABEL = labelFor(EXPERIMENTS.ctaLabelVariant)
const TARGET_URL = isTicketingOpen ? TICKETING_BASE_URL : '/billetterie-fermee'
---

<a
    href={TARGET_URL}
    class="btn btn-primary inline-flex items-center gap-2 hover-lift"
    data-cta
    data-placement="header"
    data-base-href={TARGET_URL}
    aria-label={CTA_LABEL}>
    <span>ðŸŽ«</span>
    <span>{CTA_LABEL}</span>
</a>

<script>
    import { mergeUtm, getIncomingUtmFromLocation, buildUrlWithUtm } from '../../utils/utm'
    import { UTM_DEFAULTS } from '../../config/cta'

    // Enhance all anchors with data-cta on the page (supports multiple placements)
    document.addEventListener('astro:page-load', () => {
        const anchors = document.querySelectorAll('a[data-cta][data-base-href]') as NodeListOf<HTMLAnchorElement>
        anchors.forEach((a) => {
            const base = a.getAttribute('data-base-href') || a.href
            const placement = a.getAttribute('data-placement') || 'unknown'
            a.addEventListener(
                'click',
                () => {
                    // Merge incoming UTM with defaults
                    const incoming = getIncomingUtmFromLocation(window.location)
                    const utm = mergeUtm(incoming, UTM_DEFAULTS)
                    a.href = buildUrlWithUtm(base, utm)
                    // Fire analytics if available (Plausible respects consent via localStorage)
                    try {
                        // @ts-ignore
                        if (window.plausible) window.plausible('cta_click', { props: { placement, ...utm } })
                    } catch {}
                },
                { once: false, capture: true }
            )
        })
    })
</script>
