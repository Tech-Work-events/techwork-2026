---
/**
 * Panneau de réglages d'accessibilité
 * Adapté depuis le site CTO de Lyon (cto-de-lyon.fr)
 *
 * Fonctionnalités :
 * - Taille de police (small / normal / large / xlarge)
 * - Police adaptée aux dyslexiques (OpenDyslexic)
 * - Contraste élevé
 * - Espacement des lignes
 * - Espacement des lettres
 * - Persistance localStorage
 */
---

<!-- Bouton flottant mobile -->
<div class="fixed bottom-8 left-4 z-40 lg:hidden">
    <button
        id="accessibility-toggle"
        class="bg-primary-600 text-white rounded-full p-4 shadow-lg transition-all focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 hover:bg-primary-700"
        aria-label="Ouvrir les paramètres d'accessibilité"
        aria-expanded="false"
        aria-controls="accessibility-overlay">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"
            ></path>
        </svg>
    </button>
</div>

<!-- Overlay modal -->
<div
    id="accessibility-overlay"
    class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
    role="dialog"
    aria-labelledby="accessibility-title"
    aria-modal="true">
    <div
        id="accessibility-menu"
        class="relative w-full max-w-md bg-white rounded-2xl shadow-2xl border border-gray-100 p-6 space-y-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h2 id="accessibility-title" class="text-xl font-bold text-gray-900">Accessibilité</h2>
            <button
                id="accessibility-close"
                class="text-gray-400 hover:text-gray-700 transition-colors p-1 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                aria-label="Fermer les paramètres d'accessibilité">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"
                    ></path>
                </svg>
            </button>
        </div>

        <!-- Taille de la police -->
        <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-900"> Taille de la police </label>
            <div class="flex gap-2">
                <button
                    data-font-size="small"
                    class="font-size-btn flex-1 px-3 py-2 text-sm rounded-lg border transition-colors"
                    aria-label="Petite taille">A-</button
                >
                <button
                    data-font-size="normal"
                    class="font-size-btn flex-1 px-3 py-2 text-sm rounded-lg border transition-colors"
                    aria-label="Taille normale">A</button
                >
                <button
                    data-font-size="large"
                    class="font-size-btn flex-1 px-3 py-2 text-sm rounded-lg border transition-colors"
                    aria-label="Grande taille">A+</button
                >
                <button
                    data-font-size="xlarge"
                    class="font-size-btn flex-1 px-3 py-2 text-sm rounded-lg border transition-colors"
                    aria-label="Très grande taille">A++</button
                >
            </div>
        </div>

        <!-- Police dyslexique -->
        <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-900"> Police adaptée aux dyslexiques </label>
            <div class="flex gap-2">
                <button
                    data-font-type="normal"
                    class="font-type-btn flex-1 px-3 py-2 text-sm rounded-lg border transition-colors"
                    aria-label="Police normale">Standard</button
                >
                <button
                    data-font-type="dyslexic"
                    class="font-type-btn flex-1 px-3 py-2 text-sm rounded-lg border transition-colors"
                    aria-label="Police dyslexique">Dyslexique</button
                >
            </div>
        </div>

        <!-- Contraste élevé -->
        <div class="flex items-center justify-between">
            <label class="text-sm font-medium text-gray-900"> Contraste élevé </label>
            <button
                id="high-contrast-toggle"
                class="relative inline-flex h-6 w-11 items-center rounded-full border-2 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500"
                role="switch"
                aria-checked="false"
                aria-label="Activer le contraste élevé">
                <span
                    class="inline-block h-4 w-4 transform rounded-full bg-white shadow transition-transform translate-x-1"
                ></span>
            </button>
        </div>

        <!-- Espacement des lignes -->
        <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-900"> Espacement des lignes </label>
            <div class="flex gap-2">
                <button
                    data-line-height="normal"
                    class="line-height-btn flex-1 px-3 py-2 text-sm rounded-lg border transition-colors">Normal</button
                >
                <button
                    data-line-height="large"
                    class="line-height-btn flex-1 px-3 py-2 text-sm rounded-lg border transition-colors">Large</button
                >
            </div>
        </div>

        <!-- Espacement des lettres -->
        <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-900"> Espacement des lettres </label>
            <div class="flex gap-2">
                <button
                    data-letter-spacing="normal"
                    class="letter-spacing-btn flex-1 px-3 py-2 text-sm rounded-lg border transition-colors"
                    >Normal</button
                >
                <button
                    data-letter-spacing="large"
                    class="letter-spacing-btn flex-1 px-3 py-2 text-sm rounded-lg border transition-colors"
                    >Large</button
                >
            </div>
        </div>

        <button
            id="reset-accessibility"
            class="w-full px-4 py-2 rounded-lg border border-gray-200 bg-gray-50 hover:bg-gray-100 text-gray-700 text-sm font-medium transition-colors"
            aria-label="Réinitialiser tous les paramètres">
            Réinitialiser
        </button>
    </div>
</div>

<script>
    function initAccessibilityPanel() {
        const STORAGE_KEYS = {
            FONT_SIZE: 'accessibility_font_size',
            FONT_TYPE: 'accessibility_font_type',
            HIGH_CONTRAST: 'accessibility_high_contrast',
            LINE_HEIGHT: 'accessibility_line_height',
            LETTER_SPACING: 'accessibility_letter_spacing',
        }

        function loadPreferences() {
            return {
                fontSize: localStorage.getItem(STORAGE_KEYS.FONT_SIZE) || 'normal',
                fontType: localStorage.getItem(STORAGE_KEYS.FONT_TYPE) || 'normal',
                highContrast: localStorage.getItem(STORAGE_KEYS.HIGH_CONTRAST) === 'true',
                lineHeight: localStorage.getItem(STORAGE_KEYS.LINE_HEIGHT) || 'normal',
                letterSpacing: localStorage.getItem(STORAGE_KEYS.LETTER_SPACING) || 'normal',
            }
        }

        function savePreferences(prefs: ReturnType<typeof loadPreferences>) {
            localStorage.setItem(STORAGE_KEYS.FONT_SIZE, prefs.fontSize)
            localStorage.setItem(STORAGE_KEYS.FONT_TYPE, prefs.fontType)
            localStorage.setItem(STORAGE_KEYS.HIGH_CONTRAST, prefs.highContrast.toString())
            localStorage.setItem(STORAGE_KEYS.LINE_HEIGHT, prefs.lineHeight)
            localStorage.setItem(STORAGE_KEYS.LETTER_SPACING, prefs.letterSpacing)
        }

        function applyAccessibilityStyles(prefs: ReturnType<typeof loadPreferences>) {
            const root = document.documentElement
            const fontSizeMap: Record<string, string> = {
                small: '0.875rem',
                normal: '1rem',
                large: '1.125rem',
                xlarge: '1.25rem',
            }
            root.style.setProperty('--accessibility-font-size', fontSizeMap[prefs.fontSize] || fontSizeMap.normal)
            root.classList.toggle('dyslexic-font', prefs.fontType === 'dyslexic')
            root.classList.toggle('high-contrast', prefs.highContrast)
            const lineHeightMap: Record<string, string> = { normal: '1.5', large: '2' }
            root.style.setProperty(
                '--accessibility-line-height',
                lineHeightMap[prefs.lineHeight] || lineHeightMap.normal
            )
            const letterSpacingMap: Record<string, string> = { normal: '0', large: '0.1em' }
            root.style.setProperty(
                '--accessibility-letter-spacing',
                letterSpacingMap[prefs.letterSpacing] || letterSpacingMap.normal
            )
        }

        function updateUI(prefs: ReturnType<typeof loadPreferences>) {
            const activeClass = 'bg-primary-600 text-white border-primary-600'
            const inactiveClass = 'bg-white text-gray-700 border-gray-200 hover:bg-gray-50'

            document.querySelectorAll<HTMLButtonElement>('.font-size-btn').forEach((btn) => {
                btn.className =
                    'font-size-btn flex-1 px-3 py-2 text-sm rounded-lg border transition-colors ' +
                    (btn.dataset.fontSize === prefs.fontSize ? activeClass : inactiveClass)
            })
            document.querySelectorAll<HTMLButtonElement>('.font-type-btn').forEach((btn) => {
                btn.className =
                    'font-type-btn flex-1 px-3 py-2 text-sm rounded-lg border transition-colors ' +
                    (btn.dataset.fontType === prefs.fontType ? activeClass : inactiveClass)
            })
            document.querySelectorAll<HTMLButtonElement>('.line-height-btn').forEach((btn) => {
                btn.className =
                    'line-height-btn flex-1 px-3 py-2 text-sm rounded-lg border transition-colors ' +
                    (btn.dataset.lineHeight === prefs.lineHeight ? activeClass : inactiveClass)
            })
            document.querySelectorAll<HTMLButtonElement>('.letter-spacing-btn').forEach((btn) => {
                btn.className =
                    'letter-spacing-btn flex-1 px-3 py-2 text-sm rounded-lg border transition-colors ' +
                    (btn.dataset.letterSpacing === prefs.letterSpacing ? activeClass : inactiveClass)
            })

            const contrastToggle = document.getElementById('high-contrast-toggle')
            if (contrastToggle) {
                contrastToggle.setAttribute('aria-checked', prefs.highContrast.toString())
                const span = contrastToggle.querySelector('span')
                if (span) {
                    if (prefs.highContrast) {
                        contrastToggle.className =
                            'relative inline-flex h-6 w-11 items-center rounded-full border-2 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 bg-primary-600 border-primary-600'
                        span.classList.remove('translate-x-1')
                        span.classList.add('translate-x-6')
                    } else {
                        contrastToggle.className =
                            'relative inline-flex h-6 w-11 items-center rounded-full border-2 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 bg-gray-200 border-gray-200'
                        span.classList.add('translate-x-1')
                        span.classList.remove('translate-x-6')
                    }
                }
            }
        }

        function openMenu() {
            const overlay = document.getElementById('accessibility-overlay')
            if (overlay) {
                overlay.classList.remove('hidden')
                document.body.style.overflow = 'hidden'
                const closeBtn = document.getElementById('accessibility-close')
                if (closeBtn) setTimeout(() => closeBtn.focus(), 100)
            }
            document
                .querySelectorAll('[id^="accessibility-toggle"]')
                .forEach((btn) => btn?.setAttribute('aria-expanded', 'true'))
        }

        function closeMenu() {
            const overlay = document.getElementById('accessibility-overlay')
            if (overlay) {
                overlay.classList.add('hidden')
                document.body.style.overflow = ''
            }
            document
                .querySelectorAll('[id^="accessibility-toggle"]')
                .forEach((btn) => btn?.setAttribute('aria-expanded', 'false'))
        }

        let prefs = loadPreferences()
        applyAccessibilityStyles(prefs)
        updateUI(prefs)

        document.getElementById('accessibility-toggle')?.addEventListener('click', openMenu)
        document.getElementById('accessibility-toggle-desktop')?.addEventListener('click', (e) => {
            e.preventDefault()
            openMenu()
        })
        document.getElementById('accessibility-close')?.addEventListener('click', closeMenu)
        document.getElementById('accessibility-overlay')?.addEventListener('click', (e) => {
            if ((e.target as HTMLElement).id === 'accessibility-overlay') closeMenu()
        })
        document.addEventListener('keydown', (e) => {
            const overlay = document.getElementById('accessibility-overlay')
            if (e.key === 'Escape' && overlay && !overlay.classList.contains('hidden')) {
                closeMenu()
            }
        })

        document.querySelectorAll<HTMLButtonElement>('.font-size-btn').forEach((btn) => {
            btn.addEventListener('click', () => {
                prefs.fontSize = btn.dataset.fontSize || 'normal'
                savePreferences(prefs)
                applyAccessibilityStyles(prefs)
                updateUI(prefs)
            })
        })
        document.querySelectorAll<HTMLButtonElement>('.font-type-btn').forEach((btn) => {
            btn.addEventListener('click', () => {
                prefs.fontType = btn.dataset.fontType || 'normal'
                savePreferences(prefs)
                applyAccessibilityStyles(prefs)
                updateUI(prefs)
            })
        })
        document.querySelectorAll<HTMLButtonElement>('.line-height-btn').forEach((btn) => {
            btn.addEventListener('click', () => {
                prefs.lineHeight = btn.dataset.lineHeight || 'normal'
                savePreferences(prefs)
                applyAccessibilityStyles(prefs)
                updateUI(prefs)
            })
        })
        document.querySelectorAll<HTMLButtonElement>('.letter-spacing-btn').forEach((btn) => {
            btn.addEventListener('click', () => {
                prefs.letterSpacing = btn.dataset.letterSpacing || 'normal'
                savePreferences(prefs)
                applyAccessibilityStyles(prefs)
                updateUI(prefs)
            })
        })
        document.getElementById('high-contrast-toggle')?.addEventListener('click', () => {
            prefs.highContrast = !prefs.highContrast
            savePreferences(prefs)
            applyAccessibilityStyles(prefs)
            updateUI(prefs)
        })
        document.getElementById('reset-accessibility')?.addEventListener('click', () => {
            prefs = {
                fontSize: 'normal',
                fontType: 'normal',
                highContrast: false,
                lineHeight: 'normal',
                letterSpacing: 'normal',
            }
            savePreferences(prefs)
            applyAccessibilityStyles(prefs)
            updateUI(prefs)
        })
    }

    document.addEventListener('astro:page-load', initAccessibilityPanel)
</script>
